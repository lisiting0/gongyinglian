<!DOCTYPE html>
<html>

	<head>

		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>退货管理</title>
		<meta name="keywords" content="退货管理">
		<meta name="description" content="退货管理">

		<link rel="shortcut icon" href="favicon.ico">
		<link href="../../css/bootstrap.min.css" rel="stylesheet">
		<link href="../../css/font-awesome.min.css" rel="stylesheet">
		<link href="../../css/plugins/bootstrap-table/bootstrap-table.min.css" rel="stylesheet">
		<link href="../../css/plugins/select2/select2.min.css" rel="stylesheet" type="text/css" />
		<link href="../../css/animate.min.css" rel="stylesheet">
		<link href="../../css/style.min.css" rel="stylesheet">
		<link href="../../css/plugins/iCheck/custom.css" rel="stylesheet">
		<link href="../../css/plugins/blueimp/css/blueimp-gallery.min.css" rel="stylesheet">
	</head>

	<body class="pd15">

		<form class="form-horizontal m-t" id="signupForm">
			<div class="col-sm-12">
				<div class="tabs-container">
					<ul class="nav nav-tabs">
						<li class="active">
							<a data-toggle="tab" href="#tab-1" aria-expanded="true"> 基本信息</a>
						</li>
						<li class="">
							<a data-toggle="tab" href="#tab-2" aria-expanded="false">物流信息</a>
						</li>
					</ul>
					<div class="tab-content">
						<div id="tab-1" class="tab-pane active">
							<div class="panel-body">
								<div class="form-group">
									<label class="col-sm-2 control-label">退货单号</label>
									<div class="col-sm-3">
										<input name="return_number" value="JA5001728" class="ui-textbox disabled-text" type="text" ltype="text">
									</div>
									<label class="col-sm-2 control-label">送货单位</label>
									<div class="col-sm-3">
										<select id="supplierSelect" class="js-example-basic-single form-control" ltype="select" ligeruiid="supplierSelect">
											<option value="">请选择</option>
											<option value="HN-GZJT-001">广州集团</option>
											<option value="HN-GZBJ-0011">广州宝玑集团</option>
											<option value="HB-BJZH-003">北京钟华集团</option>
											<option value="HB-BJZH-004">北京摇摇乐集团</option>
										</select>
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">退货类型</label>
									<div class="col-sm-3">
										<select name="return_type" class="form-control" ltype="select" ligeruiid="return_type">
											<option value=" ">请选择</option>
											<option value="不良品">不良品</option>
											<option value="采购进货" selected="selected">采购进货</option>
										</select>
									</div>
									<label class="col-sm-2 control-label">仓库</label>
									<div class="col-sm-3">
										<select id="bad_goods_warehouse" class="form-control" ltype="select" ligeruiid="bad_goods_warehouse">
											<option value=" ">请选择</option>
											<option value="世港总仓">世港总仓</option>
											<option value="顺德总仓">顺德总仓</option>
										</select>
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">操作员</label>
									<div class="col-sm-3">
										<input name="salesman" value="季童薇" class="ui-textbox disabled-text" type="text" ltype="text">
									</div>
									<label class="col-sm-2 control-label">预退货日</label>
									<div class="col-sm-3">
										<input name="prereturn_date" id="prereturn_date" value="2018-4-20" class="laydate-icon form-control layer-date" type="text" autocomplete="off">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">采购清单</label>
									<div class="col-sm-8">
										<div id="toolbar" style="margin-top: 10px;">
											<div class="btn-group">
												<button type="button" class="btn btn-outline btn-default" onclick="addInfo('添加','../../template/common/qualityinspection_list_add.html');">
					                                <i class="glyphicon glyphicon-plus" aria-hidden="true"></i> 添加
					                            </button>
												<button type="button" class="btn btn-outline btn-default" onclick="delInfo();">
					                                <i class="glyphicon glyphicon-trash" aria-hidden="true"></i> 删除
					                            </button>
											</div>
										</div>
										<table id="receiptListTable"></table>
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">退货说明</label>
									<div class="col-sm-10" style="padding: 1px 15px;">
										<textarea name="remark" placeholder="请输入退货说明" class="layui-textarea disabled-textarea" style="min-width:79.5%;min-height: 100px;height: auto;line-height: 20px;padding: 6px 10px;resize: vertical;border: 1px solid #e5e6e7;"></textarea>
									</div>
								</div>
								<div class="audit-panel display-none">
									<div class="form-group">
										<label class="col-sm-2 control-label">审核</label>
										<div class="col-sm-10">
											<div class="radio i-checks">
												<label><input type="radio" checked="" value="是" name="specialOffer"></label>审核通过
												<label><input type="radio" value="否" name="specialOffer"></label>退回修改
											</div>
										</div>
									</div>
									<div class="form-group">
										<label class="col-sm-2 control-label">审核意见</label>
										<div class="col-sm-10" style="padding: 1px 15px;">
											<textarea name="audit" placeholder="请输入审核意见" class="layui-textarea" style="min-width:79.5%;min-height: 100px;height: auto;line-height: 20px;padding: 6px 10px;resize: vertical;border: 1px solid #e5e6e7;"></textarea>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div id="tab-2" class="tab-pane">
							<div class="panel-body">
								<div class="form-group">
									<label class="col-sm-2 control-label">物流公司</label>
									<div class="col-sm-3">
										<input name="logistics_company" value="顺丰" class="ui-textbox" type="text" ltype="text" validate="{required:true,minlength:1,maxlength:100}">
									</div>
									<label class="col-sm-2 control-label">快递单号</label>
									<div class="col-sm-3">
										<input name="tracking_number" value="5000044005850" class="ui-textbox" type="text" ltype="text" validate="{required:true,minlength:1,maxlength:100}">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">收件地址</label>
									<div class="col-sm-3">
										<input name="prereturn_date" value="北京市休闲区" class="ui-textbox" type="text" ltype="text" validate="{required:true,minlength:1,maxlength:100}">
									</div>
									<label class="col-sm-2 control-label">联系人</label>
									<div class="col-sm-3">
										<input name="contact" value="张三" class="ui-textbox" type="text" ltype="text" validate="{required:true,minlength:1,maxlength:10}">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">联系电话</label>
									<div class="col-sm-3">
										<input name="contact_phone" value="13565544895" class="ui-textbox" type="text" ltype="text" validate="{required:true,minlength:1,maxlength:100}">
									</div>
									<label class="col-sm-2 control-label">固定电话</label>
									<div class="col-sm-3">
										<input name="fixed_telephone" value="" class="ui-textbox" type="text" ltype="text">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">运费</label>
									<div class="col-sm-3">
										<input name="freight" value="" class="ui-textbox" type="text" ltype="text">
									</div>
									<label class="col-sm-2 control-label">件数</label>
									<div class="col-sm-3">
										<input name="pieces" value="" class="ui-textbox" type="text" ltype="text">
									</div>
								</div>
								<div class="form-group">
									<label class="col-sm-2 control-label">重量</label>
									<div class="col-sm-3">
										<input name="weight" value="" class="ui-textbox" type="text" ltype="text">
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-sm-12 form-group text-right" style="margin-top: 10px;">
				<button class="btn btn-primary" type="submit" onclick="submitForm();">保存</button>
				<button class="btn btn-primary" type="submit" onclick="cancelLayer();">取消</button>
			</div>
		</form>

		<!--显示图片层-->
		<div id="blueimp-gallery" class="blueimp-gallery">
			<div class="slides"></div>
			<h3 class="title"></h3>
			<a class="close">×</a>
		</div>

		<script src="../../js/jquery.min.js"></script>
		<script src="../../js/bootstrap.min.js"></script>
		<script src="../../js/plugins/bootstrap-table/bootstrap-table.min.js"></script>
		<script src="../../js/plugins/bootstrap-table/bootstrap-table-mobile.min.js"></script>
		<script src="../../js/plugins/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
		<script src="../../js/plugins/bootstrap-editable/bootstrap-editable.js"></script>
		<script src="../../js/plugins/bootstrap-editable/bootstrap-table-editable.js"></script>
		<script src="../../js/plugins/select2/select2.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/js.js"></script>
		<script src="../../js/ligerui.all.js"></script>
		<script src="../../js/plugins/layer/layer.min.js"></script>
		<script src="../../js/plugins/iCheck/icheck.min.js"></script>
		<script src="../../js/plugins/layer/laydate/laydate.js"></script>
		<script src="../../js/plugins/validate/jquery.validate.min.js"></script>
		<script src="../../js/plugins/validate/messages_zh.min.js"></script>
		<script src="../../js/plugins/validate/jquery.metadata.js"></script>
		<script src="../../js/plugins/blueimp/jquery.blueimp-gallery.min.js"></script>

		<script>
			var table = $("#receiptListTable");
			$(function() {
				var loadData = [{
					id: 10001,
					order_number: 'J2018A5001728',
					code: '160M60LYXCL',
					name: 'CASIO MTP-1329D-5A',
					supplier: '北京劳力士集团',
					unit: '件',
					image: 'watch1',
					size: '通码',
					color: '通色',
					CAmount: 1,
					purchase_price: 8,
					bad_goods_location: '收货QC不良品中转仓',
					remark: ''
				}, {
					id: 10002,
					order_number: 'J2018A5001728',
					code: '002B38068M QQF-01',
					name: '表带',
					supplier: '广州环海报关服务有限公司',
					unit: '件',
					gp: '考核',
					image: 'watch1',
					size: '通码',
					color: '通色',
					CAmount: 2,
					purchase_price: 6,
					bad_goods_location: '收货QC不良品中转仓',
					remark: ''
				}, {
					id: 10003,
					order_number: 'J2018A5001728',
					code: '002B38068M QQF-01',
					name: '表带',
					supplier: '广州环海报关服务有限公司',
					unit: '件',
					gp: '考核',
					image: 'watch1',
					size: '通码',
					color: '通色',
					CAmount: 2,
					purchase_price: 5.5,
					bad_goods_location: '收货QC不良品中转仓',
					remark: ''
				}, {
					id: 10004,
					order_number: 'J2018A5001728',
					code: '160M60LYXCL',
					name: 'CASIO MTP-1339D-5A',
					supplier: '北京劳力士集团',
					unit: '件',
					gp: '考核',
					image: 'watch1',
					size: '通码',
					color: '通色',
					CAmount: 2,
					purchase_price: 9,
					bad_goods_location: '收货QC不良品中转仓',
					remark: ''
				}];

				initTable();
				$(".btn-default").addClass("btn-outline");
				if($.getUrlParam('id')) {
					table.bootstrapTable('append', loadData);
					//合并单元格
					mergeCells(loadData, "order_number", null, "#receiptListTable");
					//setData();
					//审核状态
					if($.getUrlParam('action') == 'AUDIT') {
						$('.ui-textbox').attr('disabled', 'disabled').css("background-color", "#f5f5f5");
						$('.layer-date').attr('disabled', 'disabled').css("background-color", "#f5f5f5");
						$('select[ltype=select]').attr('disabled', 'disabled').css("background-color", "#f5f5f5");
						$('.disabled-textarea').attr('disabled', 'disabled').css("background-color", "#f5f5f5");
						$('#toolbar').addClass('display-none');
						$('.audit-panel').removeClass('display-none');
					}

					var supplier_trigger = $("#supplierSelect").select2().val("HN-GZJT-001").trigger("change"); //获取selectid
					supplier_trigger.change();
					$("#supplierSelect").prop("disabled", true); //设置下拉框不可用

					$("#return_type").val("采购进货");
					$("#bad_goods_warehouse").val("世港总仓");
				} else {
					//$('input').val();
				}
				new formValidate({
					formEle: '#signupForm'
				});

				laydate({
					elem: "#prereturn_date",
					format: "YYYY/MM/DD hh:mm",
					min: laydate.now(),
					max: "2099-06-16 23:59",
					istime: true,
					istoday: false,
					choose: function(datas) {}
				});

				$(".i-checks").iCheck({
					checkboxClass: "icheckbox_square-green",
					radioClass: "iradio_square-green",
				})

				$('#supplierSelect').select2({}).on('select2:select', function(event) {});
			});

			function valid() {
				var form = liger.get("signupForm");
				alert(form.valid());
			}

			function getData() {
				var form = liger.get("signupForm");
				var data = form.getData();
				alert(JSON.stringify(data));
			}

			function setData() {
				$.ajax({
					url: USER_INFO.SITE_URL + '/tp5/public/index.php/Admin/Admin/getUser',
					data: {
						id: $.getUrlParam('id')
					},
					success: function(res) {
						res = $.parseJSON(res);
						var form = new liger.get("signupForm");
						form.setData(res);
					}
				})
			}

			function initTable() {
				table.bootstrapTable({
					search: true,
					showRefresh: true,
					showColumns: true,
					icons: {
						refresh: "glyphicon-repeat",
						columns: "glyphicon-list"
					},
					toolbar: "#toolbar",
					columns: [{
						align: 'center',
						checkbox: true
					}, {
						field: "id",
						title: "唯一编号",
						visible: false
					}, {
						field: "order_number",
						title: "订单编号"
					}, {
						field: "code",
						title: "商品代码/物料型号"
					}, {
						field: "name",
						title: "商品名称/物料名称"
					}, {
						field: "unit",
						title: "单位",
						visible: false
					}, {
						field: "size",
						title: "尺码",
						visible: false
					}, {
						field: "color",
						title: "颜色",
						visible: false
					}, {
						field: "image",
						title: "图片",
						visible: false,
						formatter: function(v) {
							return '<a href="../../img/' + v + '.jpg" title="图片" data-gallery="" class="gallery-img"><img src="../../img/' + v + '.jpg"></a>';
						}
					}, {
						title: '退货数量',
						field: 'return_quantity',
						formatter: function(value, row, index) {
							return '<input name="return_quantity" class="ui-textbox input-width" type="text" ltype="text" validate="{required:true,digits:true}" value="' + row.CAmount + '">';
						}
					}, {
						title: '库位',
						field: 'bad_goods_location'
					}, {
						title: '备注',
						field: 'remark',
						formatter: function(value, row, index) {
							if(value == undefined) {
								value = '';
							}
							return '<textarea name="remark" placeholder="请输入内容" class="layui-textarea remark">' + value + '</textarea>';
						}
					}],
					onLoadSuccess: function(data) {
						if($.getUrlParam('id')) {
							table.bootstrapTable('append', data);
							//合并单元格
							mergeCells(data, "order_number", null, "#receiptListTable");
						}

					}
				});
			}

			function addInfo(title, url, id, w, h) {
				//判断是否有选择某个商品
				if(!$("#supplierSelect").select2().val()) {
					alert('请选择送货单位');
					return;
				}
				if($("#return_type").val() == " ") {
					alert('请选择退货类型!');
					return;
				}
				if($("#bad_goods_warehouse").val() == " ") {
					alert('请选择仓库!');
					return;
				}
				var form = liger.get("signupForm");
				if(!form.valid()) {
					return;
				}

				layer.open({
					type: 2,
					maxmin: true,
					close: true,
					title: title,
					area: ['90%', '90%'],
					content: url + "?id=" + id + "&retreat" + false + "&warehouse=" + $("#bad_goods_warehouse").val(),
					end: function() {
						//合并单元格						
						mergeCell();
					}
				});
			}

			function delInfo() {
				var getSelectRows = $.map(table.bootstrapTable('getSelections'), function(row) {
					return row.id;
				});
				if(getSelectRows.length >= 1) {
					layer.confirm('您真的确定要删除吗?', {
						icon: 3,
						btn: ['确定', '取消'] //按钮
					}, function(index) {
						for(var i = 0; i < getSelectRows.length; i++) {
							table.bootstrapTable('remove', {
								field: 'id',
								values: [parseInt(getSelectRows[i])]
							});
						}
						//合并单元格
						mergeCell();
						layer.close(index);
					}, function(index) {
						layer.close(index);
					});
				} else {
					layer.alert("请选择一行删除!");
					return;
				}
			}

			function submitForm() {
				var form = liger.get("signupForm");
				if(!form.valid()) {
					return;
				}
				var data = {};
				$("input,select,textarea").each(function() {
					var name = $(this).attr("name");
					if(name && name.indexOf('ligerui') == -1) {
						data[name] = this.value;
					}
				});
				data.id = $.getUrlParam('id');

				$.ajax({
						type: 'post',
						url: USER_INFO.SITE_URL + '/tp5/public/index.php/Admin/Admin/setUser',
						data: data,
						success: function(res) {
							if(Number(res)) {
								parent.table.bootstrapTable('refresh');
								var index = parent.layer.getFrameIndex(window.name);
								parent.layer.close(index);
							}
						}
					})
					/*
					            parent.table.bootstrapTable('refresh');
					            var index = parent.layer.getFrameIndex(window.name);
					            parent.layer.close(index);*/
			}

			function mergeCell() {
				var data = table.bootstrapTable('getData', true);
				//合并单元格
				mergeCells(data, "order_number", null, "#receiptListTable");
			}
		</script>
	</body>

</html>